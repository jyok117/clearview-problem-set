---
title: "Q1"
output:
  html_document:
    df_print: paged
---


Install and load necessary packages
```{r}
install.packages("readxl")
install.packages("openxlsx")
install.packages("dplyr")
install.packages("tidyr")
install.packages("lubridate")

library(readxl)
library(openxlsx)
library(dplyr)
library(tidyr)
library(lubridate)
```


Path to your Excel file
```{r}
file_path <- "SAS_Data_Experienced.xlsx"
```


Read each sheet into a separate dataframe
```{r}
activity_df <- read_excel(file_path, sheet = "Activity")
diagnosis_df <- read_excel(file_path, sheet = "Diagnosis")
rx_df <- read_excel(file_path, sheet = "Rx")
```


Display the first few rows of each dataframe
```{r}
head(activity_df)
head(diagnosis_df)
head(rx_df)
```


---


### a) Export to Excel a list of patients that are continuously enrolled for at least 12 months at any point in time.


Reshape the activity data from wide to long format for easier sequential analysis and simplifies group operations
```{r}
activity_long <- activity_df %>%
  pivot_longer(cols = starts_with("M_"), 
               names_to = "Month", 
               values_to = "Enrolled") %>%
  arrange(Patient_ID, Month)
```


```{r}
head(activity_long)
```


Create a helper function to check for 12 consecutive months of enrollment
```{r}
has_12_consecutive <- function(enrollments) {
  rle_result <- rle(enrollments)
  any(rle_result$values == 1 & rle_result$lengths >= 12)
}
```


Group by Patient_ID and check for 12 consecutive months
```{r}
patients_continuous <- activity_long %>%
  group_by(Patient_ID) %>%
  summarise(continuous_12_months = has_12_consecutive(Enrolled)) %>%
  filter(continuous_12_months == TRUE) %>%
  select(Patient_ID)
```


```{r}
patients_continuous
```


Export the resulting patient list to a new Excel file
```{r}
write.xlsx(patients_continuous, "patients_continuously_12_months.xlsx")
```


---


### b) Export to Excel a list of patients that are continuously enrolled for the most recent 12 months.


Extract the most recent 12 months for each patient
```{r}
recent_12_months <- activity_long %>%
  group_by(Patient_ID) %>%
  slice_tail(n = 12)
```


```{r}
head(recent_12_months)
```


Check if all the recent 12 months show enrollment (1)
```{r}
recently_enrolled <- recent_12_months %>%
  group_by(Patient_ID) %>%
  summarise(All_Enrolled = all(Enrolled == 1)) %>%
  filter(All_Enrolled == TRUE) %>%
  select(Patient_ID)
```


```{r}
recently_enrolled
```


Export the resulting patient list to a new Excel file
```{r}
write.xlsx(recently_enrolled, "patients_most_recent_12_months.xlsx")
```


---


### c) Of patients in “b”, flag the patients that have received at least 2 ICD codes of any listed below (i.e. it could be 2 of the same kind or 1 of multiple different ones) in the most recent 12 months. i) 299.00, 399.88, 495.01


Read the list of patients from part (b) (most recent 12 months enrolled excel file)
```{r}
recently_enrolled <- read_excel("patients_most_recent_12_months.xlsx")
```


List of ICD codes of interest
```{r}
icd_codes_of_interest <- c("299.00", "399.88", "495.01")
```


Extract the most recent month from the Activity data (assuming the columns are ordered chronologically)
```{r}
activity_months <- colnames(activity_df)[grep("M_", colnames(activity_df))]
most_recent_month <- max(activity_months)
most_recent_year_month <- sub("M_", "", most_recent_month)
most_recent_date <- as.Date(paste0(most_recent_year_month, "31"), format = "%Y%m%d")
one_year_ago <- most_recent_date %m-% months(12)
```


```{r}
print(most_recent_date)
print(one_year_ago)
```


Ensure that only the most recent patients patients' diagnoses are considered
```{r}
recent_diagnosis_df <- diagnosis_df %>%
  filter(Patient_ID %in% recently_enrolled$Patient_ID &
         Diag_Code %in% icd_codes_of_interest)
```


```{r}
recent_diagnosis_df
```


Filter for diagnoses that occurred in the most recent 12 months
```{r}
recent_diagnosis_df <- recent_diagnosis_df %>%
  filter(Date >= one_year_ago & Date <= most_recent_date)
```


```{r}
recent_diagnosis_df
```


Filter the patients with at least 2 of the specified ICD codes in the most recent 12 months
```{r}
patients_with_at_least_2_icd <- recent_diagnosis_df %>%
  group_by(Patient_ID) %>%
  summarise(ICD_Count = n()) %>%
  filter(ICD_Count >= 2)
```


```{r}
patients_with_at_least_2_icd
```



---


### d) Of patients in “a”, flag the patients that have received at least 2 ICD codes of any listed below (i.e. it could be 2 of the same kind of 1 or multiple different ones) with a 12 month washout on the first claim (i.e. they are continuously enrolled for 12 months prior to their first claim) and 24 month look-forward period (i.e. they are continuously enrolled for 24 months after their first claim). These patients’ first ICD claim below will be referred to as “diagnosis claim” from here on out. i) 299.00, 399.88, 495.01


Import the list of patients from "a" (at least 12 months continuous enrollment) excel file
```{r}
patients_continuous <- read_excel("patients_continuously_12_months.xlsx")
```


List of ICD codes of interest
```{r}
icd_codes_of_interest <- c("299.00", "399.88", "495.01")
```


Filter the diagnosis data for only the patients in the "a" list and the ICD codes of interest
```{r}
relevant_diagnosis_df <- diagnosis_df %>%
  filter(Patient_ID %in% patients_continuous$Patient_ID &
         Diag_Code %in% icd_codes_of_interest)
```


```{r}
relevant_diagnosis_df
```


Identify the first diagnosis claim for each patient
```{r}
first_claim_df <- relevant_diagnosis_df %>%
  group_by(Patient_ID) %>%
  summarise(First_Diagnosis_Date = min(Date))
```



```{r}
first_claim_df
```


Reshape the activity data to long format to make it easier to analyze month-by-month enrollment
```{r}
activity_long <- activity_df %>%
  pivot_longer(cols = starts_with("M_"), 
               names_to = "Month", 
               values_to = "Enrollment_Status") %>%
  mutate(Month = as.Date(paste0(gsub("M_", "", Month), "01"), format = "%Y%m%d"))
```


```{r}
activity_long
```


Merge the first diagnosis claim with activity data to check for 12-month washout and 24-month look-forward
```{r}
patients_with_diagnosis_claims <- first_claim_df %>%
  left_join(activity_long, by = "Patient_ID") %>%
  mutate(Month_Enrollment_Prior = Month < First_Diagnosis_Date & 
                                   Month >= First_Diagnosis_Date - years(1),
         Month_Enrollment_After = Month > First_Diagnosis_Date & 
                                  Month <= First_Diagnosis_Date + years(2)) %>%
  group_by(Patient_ID) %>%
  summarise(Enrolled_12_Months_Prior = all(Enrollment_Status[Month_Enrollment_Prior] == 1),
            Enrolled_24_Months_After = all(Enrollment_Status[Month_Enrollment_After] == 1)) %>%
  filter(Enrolled_12_Months_Prior == TRUE & Enrolled_24_Months_After == TRUE)
```


```{r}
patients_with_diagnosis_claims
```


Flag patients with at least 2 of the specified ICD codes
```{r}
patients_with_at_least_2_icd_12_24_washout <- relevant_diagnosis_df %>%
  filter(Patient_ID %in% patients_with_diagnosis_claims$Patient_ID) %>%
  group_by(Patient_ID) %>%
  summarise(ICD_Count = n()) %>%
  filter(ICD_Count >= 2)
```


```{r}
patients_with_at_least_2_icd_12_24_washout
```


