---
title: "Q1"
output: html_notebook
---

Install and load necessary packages
```{r}
install.packages("readxl")
install.packages("openxlsx")
install.packages("dplyr")
install.packages("tidyr")

library(readxl)
library(openxlsx)
library(dplyr)
library(tidyr)
```



Path to your Excel file
```{r}
file_path <- "SAS_Data_Experienced.xlsx"
```

Read each sheet into a separate dataframe
```{r}
activity_df <- read_excel(file_path, sheet = "Activity")
diagnosis_df <- read_excel(file_path, sheet = "Diagnosis")
rx_df <- read_excel(file_path, sheet = "Rx")
```


Display the first few rows of each dataframe
```{r}
head(activity_df)
head(diagnosis_df)
head(rx_df)
```

### a) Export to Excel a list of patients that are continuously enrolled for at least 12 months at any point in time.


Reshape the activity data from wide to long format

We are reshaping the dataset from wide format to long format for easier sequential analysis and simplifies group operations
```{r}
activity_long <- activity_df %>%
  pivot_longer(cols = starts_with("M_"), 
               names_to = "Month", 
               values_to = "Enrolled") %>%
  arrange(Patient_ID, Month)
```

```{r}
head(activity_long)
```

Create a helper function to check for 12 consecutive months of enrollment
```{r}
has_12_consecutive <- function(enrollments) {
  rle_result <- rle(enrollments)
  any(rle_result$values == 1 & rle_result$lengths >= 12)
}
```

Group by Patient_ID and check for 12 consecutive months
```{r}
patients_continuous <- activity_long %>%
  group_by(Patient_ID) %>%
  summarise(continuous_12_months = has_12_consecutive(Enrolled)) %>%
  filter(continuous_12_months == TRUE) %>%
  select(Patient_ID)
```

```{r}
patients_continuous
```

Export the resulting patient list to a new Excel file
```{r}
write.xlsx(patients_continuous, "patients_continuously_12_months.xlsx")
```

### b) Export to Excel a list of patients that are continuously enrolled for the most recent 12 months.

```{r}
recent_12_months <- activity_long %>%
  group_by(Patient_ID) %>%
  slice_tail(n = 12)
```

```{r}
head(recent_12_months)
```


Check if all the recent 12 months show enrollment (1)
```{r}
recently_enrolled <- recent_12_months %>%
  group_by(Patient_ID) %>%
  summarise(All_Enrolled = all(Enrolled == 1)) %>%
  filter(All_Enrolled == TRUE) %>%
  select(Patient_ID)
```

Output the dataframe for inspection
```{r}
recently_enrolled
```

Export the resulting patient list to a new Excel file
```{r}
write.xlsx(recently_enrolled, "patients_most_recent_12_months.xlsx")
```

### c) Of patients in “b”, flag the patients that have received at least 2 ICD codes of any listed below (i.e. it could be 2 of the same kind or 1 of multiple different ones) in the most recent 12 months. i) 299.00, 399.88, 495.01

Read the list of patients from part (b) (most recent 12 months enrolled excel file)
```{r}
most_recent_patients <- read_excel("patients_most_recent_12_months.xlsx")
```

List of ICD codes of interest
```{r}
icd_codes_of_interest <- c("299.00", "399.88", "495.01")
```

Filter Diagnosis data for the most recent patients and specified ICD codes
```{r}
recent_12_months_diagnosis <- diagnosis_df %>%
  filter(Patient_ID %in% most_recent_patients$Patient_ID & Diag_Code %in% icd_codes_of_interest)
```

Get the diagnoses within the most recent 12 months
```{r}
recent_12_months_diagnosis <- recent_12_months_diagnosis %>%
  mutate(Date = as.Date(Date)) %>%
  arrange(Patient_ID, Date) %>%
  group_by(Patient_ID) %>%
  slice_tail(n = 12)
```

Count ICD codes for each patient and filter those with at least 2 codes
```{r}
patients_with_at_least_2_icd <- recent_12_months_diagnosis %>%
  group_by(Patient_ID) %>%
  summarise(ICD_Count = n()) %>%
  filter(ICD_Count >= 2)
```

```{r}
patients_with_at_least_2_icd
```




